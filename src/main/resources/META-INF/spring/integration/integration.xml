<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:int="http://www.springframework.org/schema/integration"
	   xmlns:int-ip="http://www.springframework.org/schema/integration/ip"
	   xmlns:context="http://www.springframework.org/schema/context"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/ip http://www.springframework.org/schema/integration/ip/spring-integration-ip.xsd">

	<context:property-placeholder/>
                                 
	<!-- Server side -->

	<int-ip:tcp-connection-factory id="crLfServer"
								   type="server"
								   port="65530"/>
    
    <int-ip:tcp-outbound-channel-adapter id="outboundServer"
        channel="tcpOutputChannel"
        connection-factory="crLfServer"/>
        
    <int:channel id="tcpOutputChannel"/>
    
    <int:chain input-channel="toTcpClient" output-channel="tcpOutputChannel">
        <int:transformer ref="messageConverter" method="convertBack"/>
       <int:transformer ref="messageDecoder" method="encode"/>       
    </int:chain>
     
    <int:channel id="toTcpClient"/>  
        
	
	<int-ip:tcp-inbound-channel-adapter id="inboundServer"
	    channel="tcpInputChannel"
	    connection-factory="crLfServer"/>

	<int:channel id="tcpInputChannel">
	   <int:interceptors>
	       <int:wire-tap channel="toLogging"/> 
	   </int:interceptors>
	</int:channel>
		
	
	<int:chain input-channel="tcpInputChannel" output-channel="toEngineChannel">
	   <int:transformer ref="messageChecker" method="check"/>
	   <int:transformer ref="messageDecoder" method="decode"/>
	   <int:transformer ref="messageConverter" method="convert"/>
	 </int:chain>
	
	<bean id="messageChecker"
          class="com.apu.TcpServerForAccessControl.utils.message.MessageChecker"/>
	
	<bean id="messageDecoder"
          class="com.apu.TcpServerForAccessControl.utils.message.MessageDecoder"/>
          
    <bean id="messageConverter"
          class="com.apu.TcpServerForAccessControl.utils.message.MessageConverter"/>
	
	
<!-- 	<int:publish-subscribe-channel id="toEngineChannel" apply-sequence="true"/> -->
	
	
	<int:payload-type-router input-channel="toEngineChannel">
	    <int:mapping type="com.apu.TcpServerForAccessControlAPI.packet.ServicePacket" channel="toServiceEngineChannel" />
	    <int:mapping type="com.apu.TcpServerForAccessControlAPI.packet.InfoPacket" channel="toInfoEngineChannel" />
	</int:payload-type-router>
	
	
	<int:channel id="toServiceEngineChannel"/>
	
	<int:service-activator input-channel="toServiceEngineChannel"
	                       output-channel="toTcpClient"
                           ref="serviceRulesEngine"
                           method="engine"
                           order="2"/>
                           
    
    <int:channel id="toInfoEngineChannel"/>
                           
    <int:service-activator input-channel="toInfoEngineChannel"
                           output-channel="toTcpClient"
                           ref="infoRulesEngine"
                           method="engine"
                           order="1"/>
	
	<bean id="serviceRulesEngine"
          class="com.apu.TcpServerForAccessControl.utils.engine.ServiceRulesEngine"/>
	
	<bean id="infoRulesEngine"
          class="com.apu.TcpServerForAccessControl.utils.engine.InfoRulesEngine"/>	
         
          
    <int:channel id="toLogging"/>
    
    <int:service-activator input-channel="toLogging"
                           ref="logWriter"
                           method="writeToLog"/>
                           
    <bean id="logWriter"
          class="com.apu.TcpServerForAccessControl.utils.logging.LogWriter"/>

<!-- 	<int:service-activator input-channel="toLogging" -->
<!-- 						   ref="echoService" -->
<!-- 						   method="test"/> -->

<!-- 	<bean id="echoService" -->
<!-- 		  class="com.apu.TcpServerForAccessControl.EchoService"/> -->

	<int:transformer id="errorHandler"
					 input-channel="errorChannel"
					 expression="payload.failedMessage.payload + ':' + payload.cause.message"/>

</beans>