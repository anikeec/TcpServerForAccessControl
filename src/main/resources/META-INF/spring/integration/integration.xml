<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:int="http://www.springframework.org/schema/integration"
	   xmlns:int-ip="http://www.springframework.org/schema/integration/ip"
	   xmlns:context="http://www.springframework.org/schema/context"
	   xmlns:cache="http://www.springframework.org/schema/cache"
	   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/ip http://www.springframework.org/schema/integration/ip/spring-integration-ip.xsd
		http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd">

	<context:property-placeholder/>
	
	<cache:annotation-driven />
                                 
	<!-- Server side -->

	<int-ip:tcp-connection-factory id="crLfServer"
								   type="server"
								   port="65530"
								   using-nio="true"/>
    
    <int-ip:tcp-outbound-channel-adapter id="outboundServer"
        channel="tcpOutputChannel"
        connection-factory="crLfServer"/>
        
    <int:channel id="tcpOutputChannel"/>
    
    <int:chain input-channel="toTcpClient" output-channel="tcpOutputChannel">
        <int:transformer ref="messageConverter" method="convertBack"/>
       <int:transformer ref="messageDecoder" method="encode"/>       
    </int:chain>
     
    <int:channel id="toTcpClient"/>  
        
	
	<int-ip:tcp-inbound-channel-adapter id="inboundServer"
	    channel="tcpInputChannel"
	    connection-factory="crLfServer"/>

	<int:channel id="tcpInputChannel">
<!-- 	   <int:interceptors> -->
<!-- 	       <int:wire-tap channel="toLogging"/>  -->
<!-- 	   </int:interceptors> -->
	</int:channel>
	
	<!-- temp -->
<!-- 	<int:chain input-channel="tcpInputChannel" output-channel="tcpOutputChannel"> -->
<!--        <int:transformer ref="messageEcho" method="echo"/> -->
<!--      </int:chain> -->
<!--      <bean id="messageEcho" -->
<!--           class="com.apu.TcpServerForAccessControl.utils.message.MessageEcho"/> -->
    <!-- tempFinish -->
	
	<int:chain input-channel="tcpInputChannel" output-channel="toEngineChannel">
	   <int:transformer ref="messageChecker" method="check"/>
	   <int:transformer ref="messageDecoder" method="decode"/>
	   <int:transformer ref="messageConverter" method="convert"/>
	 </int:chain>
	 
	 <int:channel id="toEngineChannel"/>
	
	<bean id="messageChecker"
          class="com.apu.TcpServerForAccessControl.utils.message.MessageChecker"/>
	
	<bean id="messageDecoder"
          class="com.apu.TcpServerForAccessControl.utils.message.MessageDecoder"/>
          
    <bean id="messageConverter"
          class="com.apu.TcpServerForAccessControl.utils.message.MessageConverter"/>
	
	
<!-- 	<int:publish-subscribe-channel id="toEngineChannel" apply-sequence="true"/> -->
	
	
	<int:payload-type-router input-channel="toEngineChannel">
	    <int:mapping type="com.apu.TcpServerForAccessControlAPI.packet.ServicePacket" channel="toServiceEngineChannel" />
	    <int:mapping type="com.apu.TcpServerForAccessControlAPI.packet.InfoPacket" channel="toInfoEngineChannel" />
	    <int:mapping type="com.apu.TcpServerForAccessControlAPI.packet.AccessPacket" channel="toAccessEngineChannel" />
	</int:payload-type-router>
	
	
	<int:channel id="toServiceEngineChannel"/>
	
	<int:service-activator input-channel="toServiceEngineChannel"
	                       output-channel="toTcpClient"
                           ref="serviceRulesEngine"
                           method="engine"
                           order="2"/>
                           
    
    <int:channel id="toInfoEngineChannel"/>
                           
    <int:service-activator input-channel="toInfoEngineChannel"
                           output-channel="toTcpClient"
                           ref="infoRulesEngine"
                           method="engine"
                           order="3"/>
                           
    <int:channel id="toAccessEngineChannel"/>
    
    <int:service-activator input-channel="toAccessEngineChannel"
                           output-channel="toTcpClient"
                           ref="accessRulesEngine"
                           method="engine"
                           order="1"/>
	
	<bean id="serviceRulesEngine"
          class="com.apu.TcpServerForAccessControl.utils.engine.ServiceRulesEngine"/>
	
	<bean id="infoRulesEngine"
          class="com.apu.TcpServerForAccessControl.utils.engine.InfoRulesEngine"/>	
          
    <bean id="accessRulesEngine"
          class="com.apu.TcpServerForAccessControl.utils.engine.AccessRulesEngine"/>  
         
          
    <int:channel id="toLogging"/>
    
    <int:service-activator input-channel="toLogging"
                           ref="logWriter"
                           method="writeToLog"/>
                           
    <bean id="logWriter"
          class="com.apu.TcpServerForAccessControl.utils.logging.LogWriter"/>

<!-- 	<int:service-activator input-channel="toLogging" -->
<!-- 						   ref="echoService" -->
<!-- 						   method="test"/> -->

<!-- 	<bean id="echoService" -->
<!-- 		  class="com.apu.TcpServerForAccessControl.EchoService"/> -->

	<int:channel id="errorChannel"/>

	<int:transformer id="errorHandler"
					 input-channel="errorChannel"
					 expression="payload.failedMessage.payload + ':' + payload.cause.message"/>
					 
	<bean id="dataSource" destroy-method="close" class="org.apache.commons.dbcp2.BasicDataSource">
	    <property name="driverClassName" value="org.postgresql.Driver"/>
	    <property name="url" value="jdbc:postgresql://localhost:5432/accesscontroldb"/>
	    <property name="username" value="postgres"/>
	    <property name="password" value=""/>
	    <property name="initialSize" value="5"/>
	</bean>		
	
<!--     <bean id="cacheManager" class="org.springframework.cache.support.SimpleCacheManager">  -->
<!-- 	    <property name="caches">  -->
<!-- 	        <set>  -->
<!-- 	            <bean class="org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean" name="card"/>  -->
<!-- 	            <bean class="org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean" name="device"/>  -->
<!-- 	            <bean class="org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean" name="eventtype"/>  -->
<!-- 	            <bean class="org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean" name="rule"/>  -->
<!-- 	            <bean class="org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean" name="ruletype"/>  -->
<!-- 	        </set>  -->
<!-- 	    </property>  -->
<!-- 	</bean> -->

</beans>